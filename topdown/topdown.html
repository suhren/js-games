<canvas id="gc" width="400" height="400"></canvas>
<script>
    canvas = document.getElementById("gc");
    context = canvas.getContext("2d");
        
    window.onload=function() {
        document.addEventListener("keydown", keydown);
        document.addEventListener("keyup", keyup);
        setInterval(game, 1000/60);
    }
    
    var WIDTH = canvas.width;
    var HEIGHT = canvas.height;


    class Rectangle {
        constructor(x, y, w, h) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
        }
        left() { return this.x; } 
        right() { return this.x + this.w; }
        top() { return this.y; }
        bottom() { return this.y + this.h; }
    }

    var boxes = [
        new Rectangle(0, 0, WIDTH, 10),
        new Rectangle(0, HEIGHT - 10, WIDTH, 10),
        new Rectangle(0, 0, 10, HEIGHT),
        new Rectangle(WIDTH - 10, 0, 10, HEIGHT),
        new Rectangle(100, 100, 50, 80),
        new Rectangle(250, 250, 100, 30),
    ];

    var player = new Rectangle(200, 200, 20, 20);
    var pc = "red";
    var pvm = 2.0;
    var pvx = pvy = 0.0;
    var pdx = pdy = 0;

    function intersect(r1, r2) {        
        return !(r2.left() > r1.right() || 
                 r2.right() < r1.left() || 
                 r2.top() > r1.bottom() ||
                 r2.bottom() < r1.top());
    }

    function solve(box) {

        // Moving to the right
        if (pvx > 0) {
            // Moving down to the right
            if (pvy > 0) {
                ox = player.x - pvx 
                oy = player.y - pvy
                tx = Math.abs((box.x - (ox + player.w)) / pvx);
                ty = Math.abs((box.y - (oy + player.h)) / pvy);
                
                // Horizontal collision
                if (tx < ty) {
                    pvx = 0;
                    player.x = box.x - player.w - 1;
                }
                // Vertical collision
                else {
                    pvy = 0;
                    player.y = box.y - player.h - 1;
                }
            }
            // Moving up to the right
            else if (pvy < 0) {
                ox = player.x - pvx 
                oy = player.y - pvy
                tx = Math.abs((box.x - (ox + player.w)) / pvx);
                ty = Math.abs((box.y + box.h - oy) / pvy);
                
                // Horizontal collision
                if (tx < ty) {
                    pvx = 0;
                    player.x = box.x - player.w - 1;
                }
                // Vertical collision
                else {
                    pvy = 0;
                    player.y = box.y + box.h + 1;
                }
            }
            else {
                pvx = 0;
                player.x = box.x - player.w - 1;
            }
        }

        // Moving to the left
        else if (pvx < 0) {

            // Moving down to the left
            if (pvy > 0) {
                ox = player.x - pvx 
                oy = player.y - pvy
                tx = Math.abs((box.x + box.w - ox) / pvx);
                ty = Math.abs((box.y - (oy + player.h)) / pvy);
                
                // Horizontal collision
                if (tx < ty) {
                    pvx = 0;
                    player.x = box.x + box.w + 1;
                }
                // Vertical collision
                else {
                    pvy = 0;
                    player.y = box.y - player.h - 1;
                }
            }
            // Moving up to the left
            else if (pvy < 0) {
                ox = player.x - pvx 
                oy = player.y - pvy
                tx = Math.abs((box.x + box.w - ox) / pvx);
                ty = Math.abs((box.y + box.h - oy) / pvy);
                
                // Horizontal collision
                if (tx < ty) {
                    pvx = 0;
                    player.x = box.x + box.w + 1;
                }
                // Vertical collision
                else {
                    pvy = 0;
                    player.y = box.y + box.h + 1;
                }
            }
            else {
                pvx = 0;
                player.x = box.x + box.w + 1;
            }
        }

        // Not moving horizontally
        else {
            // Moving down
            if (pvy > 0) {
                pvy = 0;
                player.y = box.y - player.h - 1;
            }
            // Moving up
            else if(pvy < 0) {
                pvy = 0;
                player.y = box.y + box.h + 1;
            }
        }
    }

    function collision() {
        var isColliding = false;

        for (box of boxes) {
            if (intersect(player, box)) {
                solve(box);
                isColliding = true;
            }
        }

        if (isColliding) {
            pc = "green";
        }
        else {
            pc = "red"
        }
    }

    function drawRect(ctx, rect, fill="blue", stroke="black", width=2) {
        context.fillStyle = fill;
        context.strokeStyle = stroke;
        context.lineWidth = width;
        context.fillRect(rect.x, rect.y, rect.w, rect.h);
        context.strokeRect(rect.x, rect.y, rect.w, rect.h);
    }

    function game() {
        

        pvx = pdx * pvm; 
        pvy = pdy * pvm;
        player.x += pvx;
        player.y += pvy;
        collision();
        
        // Clear the screen
        context.fillStyle = "gray";
        context.fillRect(0, 0, WIDTH, HEIGHT);

        // Draw the boxes
        for (box of boxes)
            drawRect(context, box, fill="blue")
        
        // Draw the player
        drawRect(context, player, fill=pc)
    }

    function keydown(event) {
        switch(event.keyCode) {
            // Left
            case 37:
                pdx = -1; 
                break;
            // Up
            case 38:
                pdy = -1;
                break;
            // Right
            case 39:
                pdx = 1;
                break;
            // Down
            case 40:
                pdy = 1;
                break;
        }
    }


    function keyup(event) {
        switch(event.keyCode) {
            // Left
            case 37:
                if (pdx < 0) {
                    pdx = 0;    
                }
                break;
            // Up
            case 38:
                if (pdy < 0) {
                    pdy = 0;    
                }
                break;
            // Right
            case 39:
                if (pdx > 0) {
                    pdx = 0;    
                }
                break;
            // Down
            case 40:
                if (pdy > 0) {
                    pdy = 0;    
                }
                break;
        }
    }
</script>